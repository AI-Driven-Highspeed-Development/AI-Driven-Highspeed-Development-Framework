import os
import json

project_folder = os.path.basename(os.getcwd())
workspace_file = f"{project_folder}.code-workspace"

def _ensure_key(data: dict, key: str, default_value):
    if key not in data:
        data[key] = default_value

def _chain_ensure_key(data: dict, keys: list, default_value: list):
    """Ensure nested keys exist with corresponding default values."""
    current = data
    for i, key in enumerate(keys):
        _ensure_key(current, key, default_value[i])
        current = current[key]
    return current
    

if os.path.exists(workspace_file):
    #read the file as json
    with open(workspace_file, 'r') as f:
        workspace_data = json.load(f)
        servers = _chain_ensure_key(workspace_data, ['settings', 'mcp', 'servers'], [{}, {}, {}])
        
        command = f"${{workspaceFolder:{project_folder}}}/.venv/bin/python"
        args = [f"${{workspaceFolder:{project_folder}}}/project/mcp_test.py"]
        
        servers['{{module_name}}'] = {
					"type": "stdio",
					"command": command,
					"args": args
				}

        workspace_data['settings']['mcp']['servers'] = servers

        #write back the file
        with open(workspace_file, 'w') as f:
            json.dump(workspace_data, f, indent=4)